# Codecov configuration for BenchMARL
# https://docs.codecov.com/docs/codecov-yaml

codecov:
  require_ci_to_pass: yes
  notify:
    after_n_builds: 3  # Wait for 3 builds (Python 3.9, 3.10, 3.11 on ubuntu-latest)
    wait_for_ci: yes

coverage:
  precision: 2
  round: down
  range: "70...100"

  status:
    project:
      default:
        target: 90%
        threshold: 1.5%  # Allow 1.5% drop in coverage
        if_ci_failed: error
        informational: false
        only_pulls: false

    patch:
      default:
        target: 75%
        threshold: 5%
        if_ci_failed: error
        informational: false
        only_pulls: true

comment:
  layout: "header, diff, flags, components, footer"
  behavior: default
  require_changes: false
  require_base: no
  require_head: yes

  # Show coverage details in PR comments
  show_carryforward_flags: true

flags:
  unittests:
    paths:
      - benchmarl/
    carryforward: false

# Ignore paths (these should match .coveragerc but codecov uses its own syntax)
ignore:
  - "examples/**/*"
  - "docs/**/*"
  - "notebooks/**/*"
  - "fine_tuned/**/*"
  - "test/**/*"
  - "benchmarl/conf/**/*"
  - "**/__init__.py"
  - "setup.py"
  - "setup.cfg"

# Component-based coverage (for detailed insights)
component_management:
  default_rules:
    statuses:
      - type: project
        target: 90%

  individual_components:
    # Core algorithm implementations should have high coverage
    - component_id: algorithms
      name: Algorithm Implementations
      paths:
        - benchmarl/algorithms/**/*.py
      rules:
        statuses:
          - type: project
            target: 90%
            threshold: 2%

    # Model implementations should have high coverage
    - component_id: models
      name: Model Implementations
      paths:
        - benchmarl/models/**/*.py
      rules:
        statuses:
          - type: project
            target: 90%
            threshold: 2%

    # Experiment and core logic should have high coverage
    - component_id: experiment
      name: Experiment Core
      paths:
        - benchmarl/experiment/**/*.py
      rules:
        statuses:
          - type: project
            target: 90%
            threshold: 2%

    # Environment wrappers can have lower coverage due to external dependencies
    - component_id: environments
      name: Environment Wrappers
      paths:
        - benchmarl/environments/**/*.py
      rules:
        statuses:
          - type: project
            target: 80%
            threshold: 3%
            informational: true

    # Utility and helper code
    - component_id: utils
      name: Utilities
      paths:
        - benchmarl/*.py
      rules:
        statuses:
          - type: project
            target: 90%
            threshold: 2%
